<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Thermodynamics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }
        h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 28px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .session-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 25px;
        }
        .session-code {
            font-size: 24px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
        }
        .form-group { margin-bottom: 25px; }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .time-display {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
        }
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Thermodynamics Class</h1>
        <p class="subtitle">Kuwait University - Mechanical Engineering</p>
        
        <div class="session-badge">
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Session Code</div>
            <div class="session-code" id="sessionCode">------</div>
        </div>
        
        <div class="time-display" id="currentTime"></div>

        <form id="attendanceForm">
            <div class="form-group">
                <label for="studentId">Student ID</label>
                <input type="text" id="studentId" required placeholder="Enter your student ID" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="studentName">Full Name</label>
                <input type="text" id="studentName" required placeholder="Enter your full name" autocomplete="off">
            </div>

            <button type="submit" id="submitBtn">‚úì Check In</button>
        </form>

        <div class="status-message" id="statusMessage"></div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyH0zPWcMrFF0MxiJRIkYAyFHQB_k2rk-H4YLx9N5ieLVQtNV0cm2FTeDBsLSWoRL95Ew/exec';
        
        let sessionCode = '';

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
            });
        }

        function getAttendanceStatus(time) {
            const hour = time.getHours();
            const minute = time.getMinutes();
            if (hour < 13) return 'ON-TIME';
            if (hour === 13 && minute <= 5) return minute === 0 ? 'ON-TIME' : 'LATE';
            return 'VERY LATE';
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }

        document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (GOOGLE_SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbyH0zPWcMrFF0MxiJRIkYAyFHQB_k2rk-H4YLx9N5ieLVQtNV0cm2FTeDBsLSWoRL95Ew/exec') {
                showMessage('‚ùå Google Script URL not configured. Contact instructor.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';

            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const checkInTime = new Date();
            const status = getAttendanceStatus(checkInTime);

            // Get IP address
            let ipAddress = 'Unknown';
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                ipAddress = ipData.ip;
            } catch (error) {
                console.error('Error getting IP:', error);
            }

            // Prepare data for Google Sheets
            const attendanceData = {
                date: checkInTime.toISOString().split('T')[0],
                sessionCode: sessionCode,
                studentId: studentId,
                studentName: studentName,
                time: checkInTime.toLocaleTimeString('en-US', { hour12: false }),
                status: status,
                ipAddress: ipAddress
            };

            try {
                // Send to Google Sheets
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(attendanceData)
                });

                // Note: no-cors mode means we can't read the response, but the request goes through
                // Show success message
                let message = '';
                if (status === 'ON-TIME') {
                    message = `‚úì Check-in successful! Welcome, ${studentName}. You're on time!`;
                } else if (status === 'LATE') {
                    message = `‚ö†Ô∏è Check-in recorded, ${studentName}. You are marked as LATE.`;
                } else {
                    message = `‚ö†Ô∏è Check-in recorded, ${studentName}. You are marked as VERY LATE.`;
                }
                
                showMessage(message, 'success');

                // Clear form
                document.getElementById('attendanceForm').reset();
                
                // Re-enable button
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úì Check In';
                }, 2000);

            } catch (error) {
                console.error('Error submitting attendance:', error);
                showMessage('‚ùå Error recording attendance. Please try again or contact instructor.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úì Check In';
            }
        });

        // Initialize
        const urlParams = new URLSearchParams(window.location.search);
        sessionCode = urlParams.get('session') || '------';
        document.getElementById('sessionCode').textContent = sessionCode;
        updateTime();
        setInterval(updateTime, 1000);
    </script>
</body>
</html>
